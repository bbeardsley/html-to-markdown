name: Publish Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v2.6.0)"
        required: true
        type: string
      dry_run:
        description: "Prepare artifacts without publishing"
        required: false
        type: boolean
        default: false
      ref:
        description: "Git ref (branch, tag, or commit) to build; defaults to the tag"
        required: false
        type: string
      force_republish_java:
        description: "Force republish Java artifacts even if the version exists"
        required: false
        type: boolean
        default: false
      force_republish_wasm:
        description: "Force republish WASM package even if the version exists"
        required: false
        type: boolean
        default: false
  release:
    types: [published]
  repository_dispatch:
    types: [publish-release]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.ref || github.event.inputs.tag)) || github.ref || github.run_id }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare metadata
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      ref: ${{ steps.meta.outputs.ref }}
      dry_run: ${{ steps.meta.outputs.dry_run }}
      checkout_ref: ${{ steps.meta.outputs.checkout_ref }}
      target_sha: ${{ steps.meta.outputs.target_sha }}
      matrix_ref: ${{ steps.meta.outputs.matrix_ref }}
      is_tag: ${{ steps.meta.outputs.is_tag }}
      force_republish_java: ${{ steps.republish.outputs.force_republish_java }}
      force_republish_wasm: ${{ steps.republish.outputs.force_republish_wasm }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || inputs.tag || github.ref }}
          fetch-depth: 0

      - name: Validate tag and compute version
        id: meta
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_DRY_RUN: ${{ inputs.dry_run }}
          INPUT_REF: ${{ inputs.ref }}
          EVENT_RELEASE_TAG: ${{ github.event.release.tag_name }}
          EVENT_DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          EVENT_DISPATCH_DRY_RUN: ${{ github.event.client_payload.dry_run }}
          EVENT_DISPATCH_REF: ${{ github.event.client_payload.ref }}
        run: scripts/publish/validate-and-compute-metadata.sh
      - name: Resolve republish flags
        id: republish
        env:
          INPUT_FORCE_REPUBLISH_JAVA: ${{ inputs.force_republish_java }}
          INPUT_FORCE_REPUBLISH_WASM: ${{ inputs.force_republish_wasm }}
          EVENT_DISPATCH_FORCE_REPUBLISH_JAVA: ${{ github.event.client_payload.force_republish_java }}
          EVENT_DISPATCH_FORCE_REPUBLISH_WASM: ${{ github.event.client_payload.force_republish_wasm }}
        run: |
          force_java="${INPUT_FORCE_REPUBLISH_JAVA:-${EVENT_DISPATCH_FORCE_REPUBLISH_JAVA:-false}}"
          force_wasm="${INPUT_FORCE_REPUBLISH_WASM:-${EVENT_DISPATCH_FORCE_REPUBLISH_WASM:-false}}"
          echo "force_republish_java=${force_java}" >>"$GITHUB_OUTPUT"
          echo "force_republish_wasm=${force_wasm}" >>"$GITHUB_OUTPUT"
      - name: Install Task
        uses: go-task/setup-task@v1
        with:
          version: 3.46.4

      - name: Upload release metadata
        uses: actions/upload-artifact@v6
        with:
          name: release-metadata
          path: release-metadata.json
          retention-days: 14

  check-pypi:
    name: Check PyPI for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check PyPI version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-pypi-version.sh

  check-npm:
    name: Check npm for existing versions
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      node_exists: ${{ steps.check.outputs.node_exists }}
      wasm_exists: ${{ steps.check.outputs.wasm_exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check npm packages
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-npm-packages.sh

  check-rubygems:
    name: Check RubyGems for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check RubyGems version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-rubygems-version.sh

  check-hex:
    name: Check Hex.pm for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check Hex version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/elixir/check-hex-version.sh

  check-maven:
    name: Check Maven Central for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check Maven version
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-maven-version.sh

  check-nuget:
    name: Check NuGet for existing version
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Check NuGet package
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-nuget-version.sh

  check-cratesio:
    name: Check crates.io for existing versions
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      rs_exists: ${{ steps.check.outputs.rs_exists }}
      cli_exists: ${{ steps.check.outputs.cli_exists }}
      all_exist: ${{ steps.check.outputs.all_exist }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Query crates.io
        id: check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/check-cratesio-versions.sh

  check-homebrew:
    name: Check if Homebrew formula already published
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Check Homebrew tap for formula
        id: check
        timeout-minutes: 3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          # Check if Formula/html-to-markdown.rb exists and contains the current version
          # Use timeout to prevent hanging on API issues
          if timeout 120s gh api repos/kreuzberg-dev/homebrew-tap/contents/Formula/html-to-markdown.rb --jq '.content' 2>/dev/null | base64 -d | grep -q "version \"${VERSION}\""; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Homebrew formula already contains version ${VERSION}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Homebrew formula does not contain version ${VERSION} or check failed" >> "$GITHUB_STEP_SUMMARY"
          fi

  python-wheels:
    name: Build Python wheels (${{ matrix.os }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Build wheels
        uses: ./.github/actions/build-wheels
        with:
          python-version: "3.13"

      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: python-wheels-${{ matrix.os }}
          path: wheelhouse/*.whl
          retention-days: 14

  python-sdist:
    name: Build Python sdist
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install build dependencies
        run: scripts/publish/python/install-build-deps.sh
        shell: bash

      - name: Build CLI binary for sdist
        run: scripts/publish/python/build-cli-for-sdist.sh
        shell: bash

      - name: Prepare sdist with CLI
        run: scripts/publish/python/prepare-sdist-with-cli.sh
        shell: bash

      - name: Build sdist
        run: scripts/publish/python/build-sdist.sh
        shell: bash

      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: python-sdist
          path: packages/python/dist/*.tar.gz
          retention-days: 14

  php-pie:
    name: Build PHP PIE source bundle
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: stable

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:2.9.1
          coverage: none

      - name: Ensure packaging script is executable
        run: scripts/publish/php/ensure-package-script-executable.sh
        shell: bash

      - name: Assemble PIE source archive
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/php/assemble-pie-archive.sh
        shell: bash

      - name: Download PIE CLI
        run: scripts/publish/php/download-pie-cli.sh
        shell: bash

      - name: Verify PIE build from archive
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/php/verify-pie-archive.sh
        shell: bash

      - name: Upload PIE source archive
        uses: actions/upload-artifact@v6
        with:
          name: php-pie-src
          path: "build/artifacts/php_html_to_markdown-${{ needs.prepare.outputs.version }}-src.tgz"
          retention-days: 14

  node-typescript-defs:
    name: Generate Node TypeScript definitions
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Install Node dependencies
        run: scripts/publish/node/install-node-deps.sh
        shell: bash

      - name: Generate TypeScript definitions
        run: scripts/publish/node/generate-typescript-defs.sh
        shell: bash

      - name: Upload TypeScript definitions
        uses: actions/upload-artifact@v6
        with:
          name: node-typescript-defs
          path: typescript-defs/
          retention-days: 14

  node-bindings:
    name: Build Node bindings (${{ matrix.target }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            rust_target: x86_64-unknown-linux-musl
            use_cross: true
            use_napi_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            rust_target: aarch64-unknown-linux-gnu
            use_cross: false
            use_napi_cross: true
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            rust_target: aarch64-unknown-linux-musl
            use_cross: true
            use_napi_cross: false
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            rust_target: armv7-unknown-linux-gnueabihf
            use_cross: false
            use_napi_cross: true
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            rust_target: aarch64-pc-windows-msvc
            use_cross: false
            use_napi_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target
        if: ${{ matrix.rust_target != '' }}
        env:
          RUST_TARGET: ${{ matrix.rust_target }}
        run: scripts/publish/common/add-rust-target.sh
        shell: bash

      - name: Install cross
        if: ${{ matrix.use_cross }}
        run: scripts/publish/cli/install-cross.sh
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Install Node dependencies
        run: scripts/publish/node/install-node-deps.sh
        shell: bash

      - name: Clean npm directory
        if: runner.os != 'Windows'
        run: scripts/publish/node/clean-npm-dir.sh
        shell: bash

      - name: Clean npm directory (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/node/clean-npm-dir.ps1

      - name: Create npm package structure
        run: scripts/publish/node/create-npm-package-structure.sh
        shell: bash

      - name: Build native module
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.target }}
          USE_CROSS: ${{ matrix.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.use_napi_cross }}
        shell: bash
        run: scripts/publish/node/build-native-module.sh

      - name: Build native module (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.target }}
          USE_CROSS: ${{ matrix.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.use_napi_cross }}
        run: scripts/publish/node/build-native-module.ps1

      - name: Package artifacts
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/node/package-artifacts.sh
        shell: bash

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/node/package-artifacts.ps1

      - name: Upload Node artifact
        uses: actions/upload-artifact@v6
        with:
          name: node-bindings-${{ matrix.target }}
          path: node-bindings-${{ matrix.target }}.tar.gz
          retention-days: 14

  wasm-bindings:
    name: Build WASM bindings
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Add wasm32 target
        run: scripts/common/ensure-wasm-target.sh
        shell: bash

      - name: Install wasm-pack
        run: scripts/common/install-wasm-pack.sh
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Install dependencies
        run: scripts/publish/wasm/install-deps.sh
        shell: bash

      - name: Build WASM bundles
        run: scripts/publish/wasm/build-bundles.sh
        shell: bash

      - name: Package WASM artifacts
        run: scripts/publish/wasm/package-artifacts.sh
        shell: bash

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wasm-bundles
          path: wasm-artifacts/*
          retention-days: 14

  cli-binaries:
    name: Build CLI binaries (${{ matrix.target }})
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: false
          - os: macos-latest
            target: aarch64-apple-darwin
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Add compilation target
        env:
          RUST_TARGET: ${{ matrix.target }}
        run: scripts/publish/common/add-rust-target.sh
        shell: bash

      - name: Install build dependencies
        if: runner.os == 'Linux'
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/install-build-deps-linux.sh
        shell: bash

      - name: Configure cross linker
        if: ${{ matrix.target == 'aarch64-unknown-linux-gnu' }}
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/configure-cross-linker.sh
        shell: bash

      - name: Install cross
        if: ${{ matrix.use_cross }}
        run: scripts/publish/cli/install-cross.sh
        shell: bash

      - name: Build CLI
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
          USE_CROSS: ${{ matrix.use_cross }}
        run: scripts/publish/cli/build-cli.sh

      - name: Package CLI artifact
        if: runner.os != 'Windows'
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/package-cli-artifact.sh

      - name: Package CLI artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.target }}
        run: scripts/publish/cli/package-cli-artifact.ps1

      - name: Upload CLI artifact
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v6
        with:
          name: cli-${{ matrix.target }}
          path: cli-${{ matrix.target }}.tar.gz
          retention-days: 14

      - name: Upload CLI artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v6
        with:
          name: cli-${{ matrix.target }}
          path: cli-${{ matrix.target }}.zip
          retention-days: 14

  ruby-gem:
    name: Build Ruby gem (${{ matrix.label }})
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux
          - os: macos-latest
            label: macos-arm64
          - os: windows-latest
            label: windows-x64
    runs-on: ${{ matrix.os }}
    env:
      RB_SYS_CARGO_PROFILE: release
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Remove cached CLI binaries
        shell: bash
        run: scripts/publish/ruby/remove-cached-cli.sh

      - name: Install MSYS2 toolchain
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/install-msys2-toolchain.ps1

      - name: Install Rust (GNU on Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/install-rust-gnu.ps1

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: scripts/publish/ruby/configure-bindgen-windows.sh

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler: "2.7.2"
          bundler-cache: false

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        run: scripts/publish/ruby/install-deps-unix.sh
        shell: bash

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/install-deps-windows.ps1

      - name: Build gem artifacts (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: scripts/publish/ruby/build-gem-unix.sh

      - name: Build gem artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/publish/ruby/build-gem-windows.ps1

      - name: Verify gem artifacts
        shell: bash
        run: scripts/publish/ruby/verify-gem-artifacts.sh

      - name: Upload gem artifacts
        uses: actions/upload-artifact@v6
        with:
          name: rubygems-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 14

  elixir-package:
    name: Build Elixir Hex package (${{ matrix.label }})
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux
            build_hex: true
          - os: macos-latest
            label: macos
            build_hex: false
    runs-on: ${{ matrix.os }}
    env:
      MIX_ENV: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28.1"

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install Hex and Rebar
        run: scripts/publish/elixir/install-hex-rebar.sh
        shell: bash

      - name: Install dependencies
        run: scripts/publish/elixir/install-deps.sh
        shell: bash

      - name: Run Elixir tests
        run: scripts/publish/elixir/run-tests.sh
        shell: bash

      - name: Build Hex package
        if: ${{ matrix.build_hex }}
        run: scripts/publish/elixir/build-hex-package.sh
        shell: bash

      - name: Upload Hex artifact
        if: ${{ matrix.build_hex }}
        uses: actions/upload-artifact@v6
        with:
          name: elixir-hex-package
          path: packages/elixir/html_to_markdown-*.tar
          retention-days: 14

  csharp-package:
    name: Build C# NuGet package
    needs: [prepare, check-nuget, csharp-ffi]
    if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: Download C# native FFI libraries
        uses: actions/download-artifact@v7
        with:
          pattern: csharp-ffi-*
          path: dist/csharp-ffi
          merge-multiple: true

      - name: Install dependencies
        run: scripts/publish/csharp/restore.sh packages/csharp/HtmlToMarkdown/HtmlToMarkdown.csproj
        shell: bash

      - name: Pack NuGet package
        run: scripts/publish/csharp/pack.sh
        shell: bash

      - name: Upload NuGet artifact
        uses: actions/upload-artifact@v6
        with:
          name: csharp-nuget
          path: artifacts/csharp/*.nupkg
          retention-days: 14

  csharp-ffi:
    name: Build C# native FFI libraries
    needs: [prepare, check-nuget]
    if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
          - os: windows-latest
            rid: win-x64
          - os: macos-latest
            rid: osx-arm64
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Build FFI library
        env:
          RID: ${{ matrix.rid }}
        run: scripts/publish/csharp/build-ffi.sh "${RID}" dist/csharp-ffi
        shell: bash

      - name: Upload FFI artifact
        uses: actions/upload-artifact@v6
        with:
          name: csharp-ffi-${{ matrix.rid }}
          path: dist/csharp-ffi
          retention-days: 14

  go-ffi:
    name: Build Go native FFI libraries (${{ matrix.platform }})
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: ubuntu-24.04-arm
            platform: linux-arm64
          - os: windows-latest
            platform: windows-x64
          - os: macos-latest
            platform: darwin-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Package Go FFI library
        env:
          PLATFORM: ${{ matrix.platform }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/go/package-ffi.sh "${PLATFORM}" "${VERSION}" dist/go-ffi
        shell: bash

      - name: Upload Go FFI artifact
        uses: actions/upload-artifact@v6
        with:
          name: go-ffi-${{ matrix.platform }}
          path: dist/go-ffi
          retention-days: 14

  cargo-packages:
    name: Package Rust crates
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        env:
          TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
        run: scripts/publish/common/ensure-target-commit.sh
        shell: bash

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Add Windows Rust target
        if: runner.os == 'Windows'
        run: rustup target add x86_64-pc-windows-msvc
        shell: bash

      - name: Package crates
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/crates/package-crates.sh
        shell: bash

      - name: Upload crate packages
        uses: actions/upload-artifact@v6
        with:
          name: cargo-crates
          path: crate-artifacts/*.crate
          retention-days: 14

  upload-release-artifacts:
    name: Upload Release Artifacts
    needs:
      [
        prepare,
        python-wheels,
        python-sdist,
        php-pie,
        node-typescript-defs,
        node-bindings,
        wasm-bindings,
        cli-binaries,
        ruby-gem,
        go-ffi,
        elixir-package,
        cargo-packages,
      ]
    if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download PHP PIE artifact
        uses: actions/download-artifact@v7
        with:
          name: php-pie-src
          path: dist/php-pie

      - name: Download CLI artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: cli-*
          path: dist/cli
          merge-multiple: false

      - name: Download Go FFI artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: go-ffi-*
          path: dist/go-ffi
          merge-multiple: false

      - name: Download Elixir package
        uses: actions/download-artifact@v7
        with:
          name: elixir-hex-package
          path: dist/elixir

      - name: Upload PHP PIE source bundle
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/upload-php-pie.sh
        shell: bash

      - name: Upload CLI binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: scripts/publish/upload-cli-artifacts.sh
        shell: bash

      - name: Upload Go FFI artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: scripts/publish/upload-go-ffi-artifacts.sh
        shell: bash

      - name: Upload Elixir package
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: scripts/publish/upload-elixir-package.sh
        shell: bash

  publish-crates:
    name: Publish crates.io packages
    needs: [prepare, upload-release-artifacts, check-cratesio]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-cratesio.outputs.all_exist != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Cargo.toml version matches tag
        env:
          TAG_VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/crates/verify-cargo-version.sh
        shell: bash

      - name: Publish html-to-markdown-rs
        if: ${{ needs.check-cratesio.outputs.rs_exists != 'true' }}
        env:
          CARGO_TOKEN: ${{ secrets.CARGO_TOKEN }}
        run: scripts/publish/crates/publish-rs.sh
        shell: bash

      - name: Wait for indexing
        if: ${{ needs.check-cratesio.outputs.rs_exists != 'true' }}
        run: scripts/publish/crates/wait-for-indexing.sh
        shell: bash

      - name: Publish html-to-markdown-cli
        if: ${{ needs.check-cratesio.outputs.cli_exists != 'true' }}
        env:
          CARGO_TOKEN: ${{ secrets.CARGO_TOKEN }}
        run: scripts/publish/crates/publish-cli.sh
        shell: bash

  publish-pypi:
    name: Publish Python packages to PyPI
    needs: [prepare, upload-release-artifacts, check-pypi]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-pypi.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download wheel artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: python-wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist artifact
        uses: actions/download-artifact@v7
        with:
          name: python-sdist
          path: dist

      - name: List artifacts
        run: scripts/publish/python/list-dist.sh
        shell: bash

      - name: Publish to PyPI
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          skip-existing: true

  publish-rubygems:
    name: Publish Ruby gems
    needs: [prepare, upload-release-artifacts, check-rubygems]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.is_tag == 'true' && (needs.prepare.outputs.dry_run == 'true' || needs.check-rubygems.outputs.exists != 'true') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download Ruby gem artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: rubygems-*
          path: dist
          merge-multiple: false

      - name: Setup Ruby
        if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.check-rubygems.outputs.exists != 'true' }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: false

      - name: Update RubyGems
        if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.check-rubygems.outputs.exists != 'true' }}
        run: gem update --system
        shell: bash

      - name: Configure trusted publishing credentials
        if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.check-rubygems.outputs.exists != 'true' }}
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Publish gems
        if: ${{ needs.prepare.outputs.dry_run != 'true' && needs.check-rubygems.outputs.exists != 'true' }}
        working-directory: dist
        run: ../scripts/publish/ruby/publish-gems.sh
        shell: bash

      - name: Ruby gem already published
        if: ${{ needs.check-rubygems.outputs.exists == 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/ruby/already-published-summary.sh
        shell: bash

  publish-hex:
    name: Publish Hex package
    needs: [prepare, elixir-package, upload-release-artifacts, check-hex]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-hex.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.19"
          otp-version: "28.1"

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install Hex/Rebar
        run: scripts/publish/elixir/install-hex-rebar.sh
        shell: bash

      - name: Install dependencies
        run: scripts/publish/elixir/install-deps.sh
        shell: bash

      - name: Check Hex version
        id: hex_check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/elixir/check-hex-version.sh
        shell: bash

      - name: Publish to Hex.pm
        if: ${{ steps.hex_check.outputs.exists != 'true' }}
        run: scripts/publish/elixir/publish-hex.sh
        shell: bash
        env:
          HEX_API_KEY: ${{ secrets.HEX_TOKEN }}

      - name: Hex package already published
        if: ${{ steps.hex_check.outputs.exists == 'true' }}
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/elixir/already-published-summary.sh
        shell: bash

  publish-nuget:
    name: Publish NuGet package
    needs: [prepare, csharp-package, check-nuget]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "8.0.x"

      - name: Ensure dotnet is available
        run: scripts/publish/csharp/ensure-dotnet.sh
        shell: bash

      - name: Download NuGet artifact
        uses: actions/download-artifact@v7
        with:
          name: csharp-nuget
          path: dist

      - name: Publish to NuGet
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: dotnet nuget push "dist/*.nupkg" --source https://api.nuget.org/v3/index.json --api-key "${{ secrets.NUGET_API_KEY }}" --skip-duplicate && echo "NuGet package published." >> "$GITHUB_STEP_SUMMARY"
        shell: bash

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: (echo "Dry run requested; NuGet publish skipped." && ls -1 dist/*.nupkg) >> "$GITHUB_STEP_SUMMARY"
        shell: bash

  publish-packagist:
    name: Publish to Packagist
    runs-on: ubuntu-latest
    needs: [prepare, php-pie]
    if: |
      needs.prepare.result == 'success' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.dry_run != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Trigger Packagist Update
        env:
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_API_TOKEN }}
        run: |
          curl -X POST "https://packagist.org/api/update-package?username=kreuzberg-dev&apiToken=${PACKAGIST_TOKEN}" \
            -d "repository=https://github.com/kreuzberg-dev/html-to-markdown"

  publish-maven:
    name: Publish Maven package
    needs: [prepare, upload-release-artifacts, check-maven]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && (needs.check-maven.outputs.exists != 'true' || needs.prepare.outputs.force_republish_java == 'true') }}
    runs-on: ubuntu-latest
    env:
      MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
      MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Verify Central credentials
        shell: bash
        run: |
          : "${MAVEN_USERNAME:?Set MAVEN_USERNAME to your Sonatype Central token user (namecode)}"
          : "${MAVEN_PASSWORD:?Set MAVEN_PASSWORD to your Sonatype Central token password}"

      - name: Install Maven (latest)
        shell: bash
        run: bash scripts/common/install-maven-latest.sh

      - name: Patch legacy Maven GPG arguments
        run: scripts/publish/maven/patch-legacy-gpg-args.sh
        shell: bash

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "24"
          cache: maven
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GPP_PASSPHRASE }}

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Prefer gpg2 binary
        run: scripts/publish/maven/prefer-gpg2.sh
        shell: bash

      - name: Release Maven package
        env:
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPP_PASSPHRASE }}
          GPG: /usr/bin/gpg2
        run: scripts/publish/maven/release-package.sh
        shell: bash

  publish-node:
    name: Publish Node packages
    needs: [prepare, upload-release-artifacts, check-npm]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && needs.check-npm.outputs.node_exists != 'true' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download Node artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: node-bindings-*
          path: node-artifacts
          merge-multiple: true

      - name: Download TypeScript definitions
        uses: actions/download-artifact@v7
        with:
          name: node-typescript-defs
          path: typescript-defs

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Update NPM
        run: npm install -g npm@latest
        shell: bash

      - name: Enable corepack
        run: scripts/common/enable-corepack.sh
        shell: bash

      - name: Prepare artifact directory
        run: scripts/publish/node/prepare-artifact-directory.sh
        shell: bash

      - name: Install workspace dependencies
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: scripts/publish/node/install-node-deps.sh
        shell: bash

      - name: Pack platform packages
        run: scripts/publish/node/pack-platform-packages.sh
        shell: bash

      - name: Publish native binary packages
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          # NOTE: Using NPM_TOKEN for initial scoped package publishing
          # After first successful publish, we can migrate to trusted publishing
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: scripts/publish/node/publish-native-packages.sh
        shell: bash

      - name: Publish main Node package
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          # NOTE: Using NPM_TOKEN for initial scoped package publishing
          # After first successful publish, we can migrate to trusted publishing
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        working-directory: crates/html-to-markdown-node
        run: ../../scripts/publish/node/publish-main-package.sh
        shell: bash

  publish-wasm:
    name: Publish WASM package
    needs: [prepare, upload-release-artifacts, check-npm]
    if: ${{ needs.prepare.result == 'success' && needs.prepare.outputs.tag && needs.prepare.outputs.dry_run != 'true' && needs.prepare.outputs.is_tag == 'true' && (needs.check-npm.outputs.wasm_exists != 'true' || needs.prepare.outputs.force_republish_wasm == 'true') }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Download WASM artifacts
        uses: actions/download-artifact@v7
        with:
          name: wasm-bundles
          path: wasm-artifacts

      - name: Extract WASM artifacts
        run: scripts/publish/wasm/extract-artifacts.sh
        shell: bash

      - name: Remove .gitignore files from dist directories
        run: |
          rm -f crates/html-to-markdown-wasm/dist/.gitignore
          rm -f crates/html-to-markdown-wasm/dist-node/.gitignore
          rm -f crates/html-to-markdown-wasm/dist-web/.gitignore
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      - name: Update NPM
        run: npm install -g npm@latest
        shell: bash

      - name: Configure npm authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cat > ~/.npmrc <<'EOF'
          //registry.npmjs.org/:_authToken=${NPM_TOKEN}
          @kreuzberg:registry=https://registry.npmjs.org/
          EOF
        shell: bash

      - name: Publish WASM package
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd crates/html-to-markdown-wasm
          publish_log=$(mktemp)
          set +e
          npm publish --access public 2>&1 | tee "${publish_log}"
          status=${PIPESTATUS[0]}
          set -e
          if [[ "${status}" -ne 0 ]]; then
            if grep -q "previously published versions" "${publish_log}"; then
              echo "WASM package already published; skipping."
            else
              exit "${status}"
            fi
          fi
        shell: bash

  homebrew-bottles:
    name: Build Homebrew bottles (${{ matrix.bottle_tag }})
    needs: [prepare, check-homebrew]
    if: |
      needs.prepare.outputs.is_tag == 'true' &&
      (needs.check-homebrew.outputs.exists != 'true')
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 180
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-latest
            bottle_tag: arm64_sequoia
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Homebrew
        run: |
          brew tap homebrew/core
          brew update

      - name: Extract version
        id: version
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build CLI for bottle
        run: |
          cargo build --release \
            -p html-to-markdown-cli

      - name: Create Homebrew bottle
        id: bottle
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          # Prepare bottle directory structure
          bottle_dir="/tmp/html-to-markdown-bottle"
          mkdir -p "${bottle_dir}/bin"

          # Copy the built binary
          cp target/release/html-to-markdown "${bottle_dir}/bin/"

          # Create bottle tarball
          cd "${bottle_dir}"
          bottle_filename="html-to-markdown-${VERSION}.${{ matrix.bottle_tag }}.bottle.tar.gz"
          tar -czf "${bottle_filename}" bin/

          # Calculate SHA256
          sha256=$(shasum -a 256 "${bottle_filename}" | cut -d' ' -f1)
          echo "sha256=${sha256}" >> "$GITHUB_OUTPUT"
          echo "filename=${bottle_filename}" >> "$GITHUB_OUTPUT"

          # Copy to workspace for artifact upload
          cp "${bottle_filename}" "${{ github.workspace }}/"
          echo "Bottle created: ${bottle_filename}"
          echo "SHA256: ${sha256}"

      - name: Verify bottle file in workspace
        run: |
          cd "${{ github.workspace }}"
          ls -lh html-to-markdown-*.bottle.tar.gz
          echo "Files in workspace:"
          ls -la
        shell: bash

      - name: Upload bottle artifact
        uses: actions/upload-artifact@v6
        with:
          name: homebrew-bottle-${{ matrix.bottle_tag }}
          path: html-to-markdown-${{ steps.version.outputs.version }}.${{ matrix.bottle_tag }}.bottle.tar.gz
          retention-days: 14
          if-no-files-found: error

  upload-homebrew-bottles:
    name: Upload Homebrew bottles to GitHub Release
    needs: [prepare, check-homebrew, homebrew-bottles]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      (needs.check-homebrew.outputs.exists != 'true') &&
      needs.homebrew-bottles.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Ensure GitHub release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: scripts/publish/ensure-github-release-exists.sh "${{ needs.prepare.outputs.tag }}"

      - name: Download bottle artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: homebrew-bottle-*
          path: dist/homebrew
          merge-multiple: true

      - name: Verify downloaded artifacts
        run: |
          echo "Contents of dist/homebrew:"
          ls -laR dist/homebrew || echo "dist/homebrew not found"
          echo "All dist contents:"
          ls -laR dist || echo "dist not found"
        shell: bash

      - name: Upload bottles (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: scripts/publish/upload-homebrew-bottles.sh "${{ needs.prepare.outputs.tag }}" dist/homebrew

  publish-homebrew:
    name: Update Homebrew formula
    needs: [prepare, check-homebrew, upload-homebrew-bottles]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      (needs.check-homebrew.outputs.exists != 'true') &&
      needs.upload-homebrew-bottles.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}

      - name: Extract release info
        id: release
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/homebrew/extract-release-info.sh

      - name: Download bottle artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: homebrew-bottle-*
          path: dist/homebrew
          merge-multiple: true

      - name: Extract bottle hashes
        id: bottles
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: scripts/publish/homebrew/extract-bottle-hashes.sh dist/homebrew

      - name: Setup Git credentials
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${GH_TOKEN}@github.com" > ~/.git-credentials
          git config --global user.name "html-to-markdown-bot"
          git config --global user.email "bot@kreuzberg.dev"

      - name: Update Homebrew formula with bottles
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
          DRY_RUN: 'false'
        run: scripts/publish/homebrew/update-formula-with-bottles.sh dist/homebrew homebrew-tap
