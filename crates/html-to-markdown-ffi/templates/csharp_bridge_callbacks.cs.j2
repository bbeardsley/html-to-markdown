// Code generated by generate_visitor_callbacks.py; DO NOT EDIT.
// Generator: scripts/generate_visitor_callbacks.py
// Schema: crates/html-to-markdown-ffi/visitor_callbacks.yaml
// Template: crates/html-to-markdown-ffi/templates/csharp_bridge_callbacks.cs.j2

using System;
using System.Runtime.InteropServices;

namespace HtmlToMarkdown.Visitor
{
    /// <summary>
    /// Generated visitor callback bridge methods.
    /// </summary>
    internal partial class VisitorBridge
    {
{% for callback in callbacks %}
{%- set cs_method_name = callback.name | replace('_', ' ') | title | replace(' ', '') %}
        /// <summary>
        /// {{ callback.description }}
        /// </summary>
        /// <remarks>
        /// HTML elements: {{ callback.html_elements }}<br/>
        /// Frequency: {{ callback.frequency }}
        /// </remarks>
        [UnmanagedFunctionPointer(CallingConvention.Cdecl)]
        private delegate NativeVisitResult {{ cs_method_name }}Delegate(
            IntPtr userData,
            IntPtr ctx
            {%- for param in callback.parameters -%}
            {%- if param.name != 'ctx' -%}
            ,
            {%- if param.type == 'string' %}
            IntPtr {{ param.name }}
            {%- elif param.type == 'string_array' %}
            IntPtr {{ param.name }},
            nuint {{ param.name }}Count
            {%- elif param.type == 'bool' %}
            [MarshalAs(UnmanagedType.I1)] bool {{ param.name }}
            {%- elif param.type == 'u32' %}
            uint {{ param.name }}
            {%- elif param.type == 'usize' %}
            nuint {{ param.name }}
            {%- endif %}
            {%- endif %}
            {%- endfor %}
        );

        private static NativeVisitResult {{ cs_method_name }}Callback(
            IntPtr userData,
            IntPtr ctx
            {%- for param in callback.parameters -%}
            {%- if param.name != 'ctx' -%}
            ,
            {%- if param.type == 'string' %}
            IntPtr c{{ param.name | title | replace('_', '') }}
            {%- elif param.type == 'string_array' %}
            IntPtr c{{ param.name | title | replace('_', '') }},
            nuint c{{ param.name | title | replace('_', '') }}Count
            {%- elif param.type == 'bool' %}
            bool c{{ param.name | title | replace('_', '') }}
            {%- elif param.type == 'u32' %}
            uint c{{ param.name | title | replace('_', '') }}
            {%- elif param.type == 'usize' %}
            nuint c{{ param.name | title | replace('_', '') }}
            {%- endif %}
            {%- endif %}
            {%- endfor %}
        )
        {
            try
            {
                // Extract visitor from user data
                if (userData == IntPtr.Zero)
                {
                    return NativeVisitResult.Continue();
                }

                var handle = GCHandle.FromIntPtr(userData);
                if (!(handle.Target is IHtmlVisitor visitor))
                {
                    return NativeVisitResult.Continue();
                }

                // Convert native context to managed
                var nodeContext = MarshalNodeContext(ctx);

                {%- for param in callback.parameters %}
                {%- if param.name != 'ctx' %}
                {%- if param.type == 'string' %}
                {%- if param.nullable %}
                // Convert nullable string pointer to managed string
                string? {{ param.name }} = c{{ param.name | title | replace('_', '') }} != IntPtr.Zero
                    ? Marshal.PtrToStringUTF8(c{{ param.name | title | replace('_', '') }})
                    : null;
                {%- else %}
                // Convert string pointer to managed string
                string {{ param.name }} = Marshal.PtrToStringUTF8(c{{ param.name | title | replace('_', '') }}) ?? string.Empty;
                {%- endif %}
                {%- elif param.type == 'string_array' %}
                // Convert string array to managed string[]
                string[] {{ param.name }} = new string[c{{ param.name | title | replace('_', '') }}Count];
                if (c{{ param.name | title | replace('_', '') }} != IntPtr.Zero)
                {
                    unsafe
                    {
                        IntPtr* arrayPtr = (IntPtr*)c{{ param.name | title | replace('_', '') }};
                        for (int i = 0; i < (int)c{{ param.name | title | replace('_', '') }}Count; i++)
                        {
                            {{ param.name }}[i] = Marshal.PtrToStringUTF8(arrayPtr[i]) ?? string.Empty;
                        }
                    }
                }
                {%- endif %}
                {%- endif %}
                {%- endfor %}

                // Call the managed visitor method
                var result = visitor.Visit{{ cs_method_name }}(
                    nodeContext
                    {%- for param in callback.parameters -%}
                    {%- if param.name != 'ctx' -%}
                    ,
                    {%- if param.type == 'string' or param.type == 'string_array' %}
                    {{ param.name }}
                    {%- else %}
                    c{{ param.name | title | replace('_', '') }}
                    {%- endif %}
                    {%- endif %}
                    {%- endfor %}
                );

                // Convert managed result to native
                return MarshalVisitResult(result);
            }
            catch (Exception ex)
            {
                return NativeVisitResult.Error($"Exception in {{ cs_method_name }}: {ex.Message}");
            }
        }

{% endfor %}

        /// <summary>
        /// Marshals a native NodeContext pointer to managed NodeContext.
        /// </summary>
        private static NodeContext MarshalNodeContext(IntPtr ctx)
        {
            if (ctx == IntPtr.Zero)
            {
                throw new ArgumentNullException(nameof(ctx));
            }

            var native = Marshal.PtrToStructure<NativeNodeContext>(ctx);
            return new NodeContext
            {
                NodeType = (NodeType)native.NodeType,
                TagName = Marshal.PtrToStringUTF8(native.TagName) ?? string.Empty,
                Depth = (int)native.Depth,
                IsFirstChild = native.IsFirstChild,
                IsLastChild = native.IsLastChild,
                HasSiblings = native.HasSiblings
            };
        }

        /// <summary>
        /// Marshals a managed VisitResult to native representation.
        /// </summary>
        private static NativeVisitResult MarshalVisitResult(VisitResult result)
        {
            return result.ResultType switch
            {
                VisitResultType.Continue => NativeVisitResult.Continue(),
                VisitResultType.Custom => NativeVisitResult.Custom(result.CustomOutput ?? string.Empty),
                VisitResultType.Skip => NativeVisitResult.Skip(),
                VisitResultType.PreserveHtml => NativeVisitResult.PreserveHtml(),
                VisitResultType.Error => NativeVisitResult.Error(result.ErrorMessage ?? "Unknown error"),
                _ => NativeVisitResult.Continue()
            };
        }

        [StructLayout(LayoutKind.Sequential)]
        private struct NativeNodeContext
        {
            public uint NodeType;
            public IntPtr TagName;
            public nuint Depth;
            [MarshalAs(UnmanagedType.I1)]
            public bool IsFirstChild;
            [MarshalAs(UnmanagedType.I1)]
            public bool IsLastChild;
            [MarshalAs(UnmanagedType.I1)]
            public bool HasSiblings;
            public nuint Reserved;
        }

        [StructLayout(LayoutKind.Sequential)]
        private struct NativeVisitResult
        {
            public uint ResultType;
            public IntPtr CustomOutput;
            public IntPtr ErrorMessage;

            public static NativeVisitResult Continue() => new() { ResultType = 0 };

            public static NativeVisitResult Custom(string output) => new()
            {
                ResultType = 1,
                CustomOutput = Marshal.StringToCoTaskMemUTF8(output)
            };

            public static NativeVisitResult Skip() => new() { ResultType = 2 };

            public static NativeVisitResult PreserveHtml() => new() { ResultType = 3 };

            public static NativeVisitResult Error(string message) => new()
            {
                ResultType = 4,
                ErrorMessage = Marshal.StringToCoTaskMemUTF8(message)
            };
        }
    }
}
